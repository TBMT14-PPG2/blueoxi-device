/**
 ******************************************************************************
 * File Name          : main.c
 * Description        : Main program body
 ******************************************************************************
 *
 * COPYRIGHT(c) 2015 STMicroelectronics
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *   1. Redistributions of source code must retain the above copyright notice,
 *      this list of conditions and the following disclaimer.
 *   2. Redistributions in binary form must reproduce the above copyright notice,
 *      this list of conditions and the following disclaimer in the documentation
 *      and/or other materials provided with the distribution.
 *   3. Neither the name of STMicroelectronics nor the names of its contributors
 *      may be used to endorse or promote products derived from this software
 *      without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 ******************************************************************************
 */
/* Includes ------------------------------------------------------------------*/
#include "main.h"


//#define s_BLUEOXI_SERIAL	1
#define s_BLUEOXI_WIFI		1
//#define s_BLUEOXI_MEMORY	1
//#define s_BLUEOXI_BLE		1


#define s_MEMORY_BLOCKS		40

/* USER CODE BEGIN Includes */

/* USER CODE END Includes */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */
/* Private variables ---------------------------------------------------------*/

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);

/* USER CODE BEGIN PFP */
/* Private function prototypes -----------------------------------------------*/

/* USER CODE END PFP */

/* USER CODE BEGIN 0 */

const uint8_t image[13][122] =
{
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xf8,0x1,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xfe,0x0,0x0,0x7,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xf0,0x0,0x0,0x0,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0x80,0x0,0x0,0x0,0x1f,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x3,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x7f,0xff,0xff,0xf0,
		0xff,0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x1f,0xff,0xff,0xf0,
		0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x7,0xff,0xff,0xf0,
		0xff,0xff,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xff,0xf0,
		0xff,0xff,0xf8,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0xff,0xff,0xf0,
		0xff,0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0xff,0xf0,
		0xff,0xff,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xf0,
		0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0xff,0xf0,
		0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xf0,
		0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7,0xff,0xf0,
		0xff,0xfc,0x0,0x0,0x0,0xc0,0x0,0x0,0x0,0x0,0x3,0xff,0xf0,
		0xff,0xfc,0x0,0x0,0x1,0xe0,0x0,0x0,0x0,0x0,0x3,0xff,0xf0,
		0xff,0xf8,0x0,0x0,0x3,0xf0,0x0,0x0,0x0,0x0,0x1,0xff,0xf0,
		0xff,0xf0,0x0,0x0,0x3,0xf0,0x0,0x0,0x0,0x0,0x0,0xff,0xf0,
		0xff,0xe0,0x0,0x0,0x7,0xf8,0x0,0x0,0x0,0x0,0x0,0x7f,0xf0,
		0xff,0xe0,0x0,0x0,0x7,0xb8,0x0,0x0,0x0,0x0,0x0,0x7f,0xf0,
		0xff,0xc0,0x0,0x0,0x7,0x3c,0x0,0x0,0x0,0x0,0x0,0x3f,0xf0,
		0xff,0x80,0x0,0x0,0x7,0x1c,0x0,0x0,0x0,0x0,0x0,0x3f,0xf0,
		0xff,0x80,0x0,0x0,0x7,0x1e,0x0,0x0,0x0,0x0,0x0,0x1f,0xf0,
		0xff,0x0,0x0,0x0,0xf,0xe,0x0,0x0,0x0,0x0,0x0,0xf,0xf0,
		0xff,0x0,0x0,0x0,0xf,0xe,0x0,0x0,0x0,0x0,0x0,0xf,0xf0,
		0xfe,0x0,0x0,0x0,0xe,0xf,0x0,0x0,0x0,0x0,0x0,0x7,0xf0,
		0xfe,0x0,0x0,0x0,0xe,0x7,0x0,0x0,0x0,0x0,0x0,0x7,0xf0,
		0xfe,0x0,0x0,0x0,0xe,0x7,0x0,0x0,0x0,0x0,0x0,0x7,0xf0,
		0xfc,0x0,0x0,0x0,0xe,0x7,0x80,0x0,0x0,0x0,0x0,0x3,0xf0,
		0xfc,0x0,0x0,0x0,0xe,0x3,0x80,0x0,0x0,0x0,0x0,0x3,0xf0,
		0xf8,0x0,0x0,0x0,0xe,0x3,0xc0,0x0,0x0,0x0,0x0,0x1,0xf0,
		0xf8,0x0,0x0,0x0,0x1e,0x1,0xc0,0x0,0x0,0x0,0x0,0x1,0xf0,
		0xf8,0x0,0x0,0x0,0x1e,0x1,0xc0,0x0,0x0,0x0,0x0,0x1,0xf0,
		0xf8,0x0,0x0,0x0,0x1c,0x1,0xc0,0x0,0x0,0x0,0x0,0x1,0xf0,
		0xf0,0x0,0x0,0x0,0x1c,0x1,0xe0,0x0,0x0,0x0,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x0,0x1c,0x0,0xe0,0x0,0x0,0x0,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x0,0x1c,0x0,0xe0,0x0,0x0,0x0,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x0,0x1c,0x0,0xf0,0x0,0x0,0x0,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x0,0x1c,0x0,0x70,0x0,0x0,0x0,0x0,0x0,0xf0,
		0xe0,0x0,0x0,0x0,0x3c,0x0,0x70,0x1,0xe0,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x3c,0x0,0x78,0x3,0xf8,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x38,0x0,0x38,0x7,0xfc,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x38,0x0,0x38,0xf,0x3e,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x38,0x0,0x3c,0xe,0x1e,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x78,0x0,0x1c,0x1e,0xf,0x0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x78,0x0,0x1c,0x1c,0x7,0x80,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x70,0x0,0x1e,0x3c,0x7,0x80,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0x70,0x0,0xe,0x38,0x3,0xc0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0xf0,0x0,0xf,0x38,0x1,0xc0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x0,0xe0,0x0,0xf,0x78,0x1,0xe0,0x0,0x0,0x70,
		0xe0,0x0,0x0,0x1,0xe0,0x0,0x7,0xf0,0x0,0xf0,0x0,0x0,0x70,
		0xf0,0x0,0x0,0x1,0xc0,0x0,0x3,0xf0,0x0,0x70,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x3,0xc0,0x0,0x3,0xe0,0x0,0x78,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x7,0x80,0x0,0x1,0xe0,0x0,0x3c,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0x7,0x0,0x0,0x0,0x0,0x0,0x1c,0x0,0x0,0xf0,
		0xf0,0x0,0x0,0xf,0x0,0x0,0x0,0x0,0x0,0x1e,0x0,0x0,0xf0,
		0xf8,0x0,0x0,0x1e,0x0,0x0,0x0,0x0,0x0,0xf,0x0,0x1,0xf0,
		0xf8,0x0,0x0,0x7c,0x0,0x0,0x0,0x0,0x0,0x7,0x80,0x1,0xf0,
		0xf8,0x0,0x0,0xf8,0x0,0x0,0x0,0x0,0x0,0x3,0xe0,0x1,0xf0,
		0xf8,0x0,0x7,0xf0,0x0,0x0,0x0,0x0,0x0,0x1,0xf0,0x1,0xf0,
		0xff,0xc0,0x7f,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,0xff,0xf0,
		0xff,0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0xff,0xf0,
		0xff,0xff,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0xff,0xf0,
		0xff,0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,0xf0,
		0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7,0xf0,
		0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xf0,
		0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xf0,
		0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0xf0,
		0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0xf0,
		0xff,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3f,0xf0,
		0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0xf0,
		0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0xf0,
		0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,0xf0,
		0xff,0xf8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0xff,0xf0,
		0xff,0xf8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0xff,0xf0,
		0xff,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xf0,
		0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7,0xff,0xf0,
		0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xff,0xf0,
		0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0xff,0xf0,
		0xff,0xff,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xf0,
		0xff,0xff,0xe0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x7f,0xff,0xf0,
		0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,0xff,0xf0,
		0xff,0xff,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0xff,0xff,0xf0,
		0xff,0xff,0xfe,0x0,0x0,0x0,0x0,0x0,0x0,0x7,0xff,0xff,0xf0,
		0xff,0xff,0xff,0x80,0x0,0x0,0x0,0x0,0x0,0x1f,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xc0,0x0,0x0,0x0,0x0,0x0,0x3f,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xf0,0x0,0x0,0x0,0x0,0x0,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xfc,0x0,0x0,0x0,0x0,0x3,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0x0,0x0,0x0,0x0,0xf,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xe0,0x0,0x0,0x0,0x7f,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xfe,0x0,0x0,0x3,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xe0,0x0,0x7f,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x7f,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x7f,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe3,0xff,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
		0xff,0xe2,0xf,0xce,0x3e,0x3e,0x7,0xf0,0x3f,0x1f,0x1c,0x7f,0xf0,
		0xff,0xe0,0x3,0xce,0x3e,0x3c,0x3,0xe0,0xf,0xe,0x3c,0x7f,0xf0,
		0xff,0xe0,0xc3,0xce,0x3e,0x38,0xf1,0xc3,0x7,0x84,0x3c,0x7f,0xf0,
		0xff,0xe3,0xe1,0xce,0x3e,0x38,0xf9,0x87,0xc7,0xc0,0x7c,0x7f,0xf0,
		0xff,0xe3,0xf1,0xce,0x3e,0x31,0xf8,0x8f,0xc7,0xc0,0xfc,0x7f,0xf0,
		0xff,0xe3,0xf1,0xce,0x3e,0x30,0x0,0x8f,0xe3,0xe1,0xfc,0x7f,0xf0,
		0xff,0xe7,0xf1,0xce,0x3e,0x30,0x0,0x8f,0xe3,0xe0,0xfc,0x7f,0xf0,
		0xff,0xe3,0xf1,0xce,0x3e,0x31,0xff,0x8f,0xe3,0xc0,0xfc,0x7f,0xf0,
		0xff,0xe3,0xf1,0xce,0x3e,0x31,0xff,0x8f,0xc7,0x84,0x7c,0x7f,0xf0,
		0xff,0xe1,0xe1,0xcf,0x1e,0x38,0xf8,0xc7,0xc7,0x8c,0x3c,0x7f,0xf0,
		0xff,0xe0,0x3,0xcf,0x8,0x38,0x71,0xc0,0xf,0x1e,0x1c,0x7f,0xf0,
		0xff,0xe0,0x7,0xcf,0x80,0x7c,0x3,0xe0,0x1e,0x1f,0x1c,0x7f,0xf0,
		0xff,0xff,0xf,0xff,0xc1,0xff,0xf,0xf8,0x3f,0xff,0xff,0xff,0xf0
};

/* USER CODE END 0 */

int main(void)
{

	/* USER CODE BEGIN 1 */

	/* USER CODE END 1 */

	/* MCU Configuration----------------------------------------------------------*/

	/* Reset of all peripherals, Initializes the Flash interface and the Systick. */
	HAL_Init();

	/* Configure the system clock */
	SystemClock_Config();

	/* Initialize all configured peripherals */
	MX_GPIO_Init();
	MX_USB_DEVICE_Init();



	//while(1);

	Wifi_Init();
	//Wifi_InitExt();

	/* USER CODE BEGIN 2 */


	Power_Init();

	uint32_t i, j, count = 0, len;
	uint8_t str[64];
	uint32_t val;

	GraphicsObj_t graphObj;
	Graphics_Init(&graphObj);
	Graphics_ClearBuffer(&graphObj, s_GRAPHICS_COLOR__WHITE);


	s_POWER__LCD_EN_SET();
	s_POWER__BLE_MEMS_EN_SET();

#ifdef s_BLUEOXI_WIFI
	s_POWER__WIFI_EN_SET();
#else
	s_POWER__WIFI_EN_RESET();
#endif
	s_POWER__GPS_EN_RESET();
	s_POWER__PPG_EN_SET();


	// LED TEST
	// ------------------------------------------------------------------
	WS2812B_Init();
	WS2812B_SendColor(0,0,128);


#ifdef s_BLUEOXI_MEMORY
	uint8_t flashData[256];
	FlashInfo_t flashInfo;
	Flash_Init();
	Flash_ReadInfo(&flashInfo);

	// Erase
	for(i = 0; i < s_MEMORY_BLOCKS; i++)
		Flash_EraseSector(s_FLASH__PARAMETER_SECTOR_COUNT + i);
	//Flash_EraseChip();

	/*Flash_Read(s_FLASH__PARAMETER_BLOCK_SIZE, flashData, 256);

	for(i = 0; i < 256; i++) {
		flashData[i] = i;
	}

	Flash_Program(s_FLASH__PARAMETER_BLOCK_SIZE, flashData, 256);

	memset(flashData, 0, 256);

	Flash_Read(s_FLASH__PARAMETER_BLOCK_SIZE, flashData, 256);
*/

	//Flash_Command(0x55);
	//Flash_Command(0xAA);
#endif

	uint32_t temp = 0;


	// AFE44XX Test --------------------------------------------------
	Afe44xx_ConfigHw();
	HAL_Delay(500);

	// Testing
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__LED2STC, 0x0A5A);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);
	temp = Afe44xx_ReadRegister(s_AFE44XX__LED2STC);

	if(temp == 0x0A5A) {
		WS2812B_SendColor(0,128,0);
	} else {
		WS2812B_SendColor(128,0,0);
	}

	Afe44xx_Init();
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// Turn Off LEDs
	temp = Afe44xx_ReadRegister(s_AFE44XX__LEDCNTRL);
	temp &= ~(0x00FFFF);
	temp |= 0x005050;
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__LEDCNTRL, temp);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// Set Gain
	temp = Afe44xx_ReadRegister(s_AFE44XX__TIA_AMB_GAIN);
	temp &= ~(0x000007);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__TIA_AMB_GAIN, temp | 5);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// 2nd Stage (1 - on, 0 - off)
	temp = Afe44xx_ReadRegister(s_AFE44XX__TIA_AMB_GAIN);
	temp &= ~(0x004000);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__TIA_AMB_GAIN, temp | (1<<14));
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// 2nd stage DAC
	temp = Afe44xx_ReadRegister(s_AFE44XX__TIA_AMB_GAIN);
	temp &= ~(0x0F0000);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__TIA_AMB_GAIN, temp | (2<<16));
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// 2nd Stage Gain
	temp = Afe44xx_ReadRegister(s_AFE44XX__TIA_AMB_GAIN);
	temp &= ~(0x000700);
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0000);
	Afe44xx_WriteRegister(s_AFE44XX__TIA_AMB_GAIN, temp | (2<<8));
	Afe44xx_WriteRegister(s_AFE44XX__CONTROL0, 0x0001);

	// ---------------------------------------------------------------






	SharpLcd_Init();
	SharpLcd_PowerOn();

	SharpLcd_Clear();
	SharpLcd_Clear();


	Graphics_DrawBitmap(&graphObj, 22, 23, (uint8_t *)image, 100, 122, s_GRAPHICS_COLOR__BLACK);
	Graphics_DrawString(&graphObj, 10, 10, (uint8_t *)"Hello World!", s_GRAPHICS_COLOR__BLACK);
	SharpLcd_DisplayBuffer(graphObj.pBuf);
	HAL_Delay(1000);

	Gui_UpdateValues(&graphObj, 0, 0, 0, 0);
	SharpLcd_DisplayBuffer(graphObj.pBuf);

	// SharpLcd_PowerOff();



	// TEST MOTOR
	// ------------------------------------------------------------------
	//	Motor_Init();
	//	for(i = 0; i < 10; i++)
	//	{
	//		s_MOTOR__DRIVE_SET();
	//		HAL_Delay(500);
	//		s_MOTOR__DRIVE_RESET();
	//		HAL_Delay(500);
	//	}
	// ------------------------------------------------------------------


	// BUTTON TEST
	// ------------------------------------------------------------------
	Buttons_Init();
	// ------------------------------------------------------------------

	/* USER CODE END 2 */

	/* Infinite loop */
	/* USER CODE BEGIN WHILE */



	Ble_Init();

	uint8_t packet[5];
	packet[0] = 0xA5;
	packet[1] = 0;
	packet[2] = 0;
	packet[3] = 0;
	packet[4] = ((packet[0]+packet[1]+packet[2]+packet[3])^0xFF)+1;

	count = 0;
	HAL_UART_Transmit_IT(&g_Ble_UartHandle, packet, 5);



	HAL_Delay(1000);
	//	len = sprintf(str, "+++");
	//	HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);
	//
	//	HAL_Delay(1000);
	//	len = sprintf(str, s_WIFI__CONFIG_AT);
	//	HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);


	uint8_t wifi_state = 2;



	//	HAL_Delay(3000);
	//
	uint32_t final2, final1;
	uint16_t data;

	count = 0;

#ifdef s_BLUEOXI_SERIAL
	Comm_Init();
#endif

#ifdef s_BLUEOXI_MEMORY
	Comm_Init();
#endif

#ifdef s_BLUEOXI_WIFI
	Wifi_TxInit();
	WS2812B_SendColor(0,0,128);
	// Connect
	uint8_t exit = 1;
	while(exit)
	{
		if(g_Buttons_Event == 1) {
			exit = Wifi_ProcessConnect();
			Wifi_Process();
		}
	}
#endif


	// PPG TESTING
	uint8_t		ppgI = 0, ppgSend = 0, ppgSwitch = 0;
	uint16_t	*redBuf, *irBuf, *redSend, *irSend;
	uint16_t	ppgRedData[32], ppgIrData[32];
	uint16_t	ppgRedData2[32], ppgIrData2[32];
	uint16_t	ppgRedFilt[32], ppgIrFilt[32];
	uint16_t 	ppgCount = 0;

	uint16_t 	ppgPeak;

	PPG_Init();

	redBuf = ppgRedData;
	irBuf = ppgIrData;
	redSend = ppgRedData2;
	irSend = ppgIrData2;




	// MEMORY BUFFERS AND STUFF
	uint8_t		memI = 0, memSend = 0, memSwitch = 0;
	uint16_t	*memBuf, *memBuf2;
	uint16_t	memData[128], memData2[128];
	uint32_t	memAddr = s_FLASH__PARAMETER_BLOCK_SIZE;
	uint8_t		memSendBuff[32];

	memBuf = memData;
	memBuf2 = memData2;




	WS2812B_SendColor(0,128,128);



	uint32_t bleSendTimer = HAL_GetTick();

	while (1)
	{



#ifdef s_BLUEOXI_SERIAL
		//Check if ADC ready
		if(g_Afe44xx_AdcRdy == 1 && g_Buttons_Event == 1)
		{

			g_Afe44xx_AdcRdy = 0;

			final2 = Afe44xx_ReadRegister(s_AFE44XX__LED2_ALED2VAL);
			final1 = Afe44xx_ReadRegister(s_AFE44XX__LED1_ALED1VAL);

			//			data = (final1>>8)&0xFFFF;
			//			Comm_TxData((uint8_t*)&data, sizeof(data));
			//			data = ppgCount++;
			//			Comm_TxData((uint8_t*)&data, sizeof(data));

			data = (final1>>8)&0xFFFF;
			irBuf[ppgI] = data;
			data = (final2>>8)&0xFFFF;
			redBuf[ppgI] = data;
			//irBuf[ppgI] = ppgCount++;

			// Buffer signal for SpO2 calculation
			PPG_BufferSignal(redBuf[ppgI], irBuf[ppgI]);

			ppgI = (ppgI + 1) % 32;

			if(ppgI == 0)
			{
				// Activate sending
				ppgSend = 1;
				// switch buffers
				if(ppgSwitch == 0) {
					redBuf = ppgRedData2;
					irBuf = ppgIrData2;
					redSend = ppgRedData;
					irSend = ppgIrData;
					ppgSwitch = 1;
				} else {
					redBuf = ppgRedData;
					irBuf = ppgIrData;
					redSend = ppgRedData2;
					irSend = ppgIrData2;
					ppgSwitch = 0;
				}

				PPG_Filter(redSend, ppgRedFilt);
				memcpy(redSend, ppgRedFilt, sizeof(ppgRedFilt));
			}


			if(ppgSend == 1) {

				ppgPeak = PPG_DetectPeak(redSend[ppgI]);

				Comm_TxData((uint8_t*)&ppgPeak, sizeof(data));
				//Comm_TxData((uint8_t*)&g_Ppg_SpO2, sizeof(data));
				//Comm_TxData((uint8_t*)&redSend[ppgI], sizeof(data));
				Comm_TxData((uint8_t*)&irSend[ppgI], sizeof(data));
			}
		}
#endif

#ifdef s_BLUEOXI_WIFI
		// Check if ADC ready
		if(g_Afe44xx_AdcRdy == 1 && g_Buttons_Event == 1)
		{

			g_Afe44xx_AdcRdy = 0;

			final2 = Afe44xx_ReadRegister(s_AFE44XX__LED2_ALED2VAL);
			final1 = Afe44xx_ReadRegister(s_AFE44XX__LED1_ALED1VAL);

			data = (final1>>8)&0xFFFF;
			Wifi_TxData((uint8_t*)&data, sizeof(data));
			data = (final2>>8)&0xFFFF;
			Wifi_TxData((uint8_t*)&data, sizeof(data));
		}
#endif


#ifdef s_BLUEOXI_BLE
		// BLE send pulse
		if((HAL_GetTick() - bleSendTimer) > 500)
		{
			bleSendTimer = HAL_GetTick();
			//Ble_SendPulse((uint8_t)g_Ppg_Pulse);

			if(g_Ble_UartTxReady == 1) {
				g_Ble_UartTxReady = 0;

				packet[1] = 0;
				packet[2] = (uint8_t)g_Ppg_Pulse;
				packet[4] = ((packet[0]+packet[1]+packet[2]+packet[3])^0xFF)+1;

				HAL_UART_Transmit_IT(&g_Ble_UartHandle, packet, 5);

				Gui_UpdateValues(&graphObj, 1, g_Ppg_MaxPulsePercent, (uint8_t)g_Ppg_Pulse, (uint8_t)g_Ppg_SpO2);
				SharpLcd_DisplayBuffer(graphObj.pBuf);
			}

		}
		Ble_Process();
#endif

#ifdef s_BLUEOXI_MEMORY
		//Check if ADC ready
		if(g_Afe44xx_AdcRdy == 1 && g_Buttons_Event == 1)
		{
			g_Afe44xx_AdcRdy = 0;

			final2 = Afe44xx_ReadRegister(s_AFE44XX__LED2_ALED2VAL);
			final1 = Afe44xx_ReadRegister(s_AFE44XX__LED1_ALED1VAL);

			data = (final1>>8)&0xFFFF;
			memBuf[memI++] = data;
			data = (final2>>8)&0xFFFF;
			memBuf[memI] = data;


			if(memSend == 2)
			{
				Comm_TxData((uint8_t*)&memBuf[memI-1], sizeof(data));
				Comm_TxData((uint8_t*)&memBuf[memI], sizeof(data));
			}

			memI = (memI + 1) % 128;

			if(memI == 0 && memSend == 0)
			{
				// switch buffers
				//				if(memSwitch == 0) {
				//					memRedBuf = memRedData2;
				//					memIrBuf = memIrData2;
				//					memRedSave = memRedData;
				//					memIrSave = memIrData;
				//					memSwitch = 1;
				//				} else {
				//					memRedBuf = memRedData;
				//					memIrBuf = memIrData;
				//					memRedSave = memRedData2;
				//					memIrSave = memIrData2;
				//					memSwitch = 0;
				//				}

				// Save to memory
				Flash_Program(memAddr, (uint8_t*)memBuf, 256);
				memAddr += 256;

				if(memAddr > (s_FLASH__PARAMETER_BLOCK_SIZE + 65536 * s_MEMORY_BLOCKS))
				{
					memSend = 1;
					memAddr = s_FLASH__PARAMETER_BLOCK_SIZE;
				}
			}

			if(memSend == 1)
			{
				Flash_Read(memAddr, memSendBuff, 4);
				memAddr += 4;

				Comm_TxData(&memSendBuff[0], 2);
				Comm_TxData(&memSendBuff[2], 2);

				if(memAddr > (s_FLASH__PARAMETER_BLOCK_SIZE + 65536 * s_MEMORY_BLOCKS))
				{
					memSend = 2;
				}
			}
		}
#endif

		// WiFi Send
		/*if(g_Wifi_UartTxReady == 1 && (
				g_Wifi_AtAnswer == s_WIFI_AT__OK ||
				g_Wifi_AtAnswer == s_WIFI_AT__CONNECTED ||
				g_Wifi_AtAnswer == s_WIFI_AT__WAITING_DATA)) {

			g_Wifi_UartTxReady = 0;
			g_Wifi_AtAnswer = s_WIFI_AT__NONE;
			HAL_Delay(500);

			switch(wifi_state)
			{
			case 2 :
				if(g_Wifi_Event != s_WIFI_EVENT__STATION_CONNECTED) {
					HAL_Delay(1000);
					g_Wifi_Event = s_WIFI_EVENT__NONE;
					len = sprintf(str, s_WIFI__CONFIG_CWLIF);
					HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);
				}
				else {
					WS2812B_SendColor(0,128,128);
					len = sprintf(str, s_WIFI__CONFIG_CIPMODE);
					HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);
					wifi_state++;
				}
				break;
			case 3 :
				if(g_Buttons_Event == 1) {
					g_Buttons_Event = 0;
					len = sprintf(str, s_WIFI__CONFIG_CIPSTART);
					wifi_state++;
					HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);
				}
				break;
			case 4 :
				len = sprintf(str, s_WIFI__CONFIG_CIPSEND);
				wifi_state++;
				HAL_UART_Transmit_IT(&g_Wifi_UartHandle, (uint8_t*)str, len);
				break;
			default :
				break;
			}
		}*/


















		//		HAL_Delay(500);
		//		GPIOA->BSRR = GPIO_PIN_5;
		//		HAL_Delay(100);
		//		GPIOA->BSRR = GPIO_PIN_5 << 16;

		// BLE Send
		//		if(g_Ble_UartTxReady == 1) {
		//			g_Ble_UartTxReady = 0;
		//			len = sprintf(str, "%d\n", (int)count);
		//			HAL_UART_Transmit_IT(&g_Ble_UartHandle, (uint8_t*)str, len);
		//			count = (count+1) % 1000;
		//		}

		//		HAL_Delay(10);
		//		if(g_Buttons_Event == 1) {
		//			Comm_TxPacket();
		//		}

		// BLE Send
		//		if(g_Ble_UartTxReady == 1) {
		//			g_Ble_UartTxReady = 0;
		//
		//			packet[1] = 0;
		//			packet[2] = count;
		//			packet[4] = ((packet[0]+packet[1]+packet[2]+packet[3])^0xFF)+1;
		//
		//			HAL_UART_Transmit_IT(&g_Ble_UartHandle, packet, 5);
		//			count = (count+1) % 100;
		//		}
		//
		//		Ble_Process();

		//len = sprintf(str, "%d\n", (int)count);
		//CDC_Transmit_FS(str, len);
		//count = (count+1) % 1000;

		//WS2812B_SendBit(1);


		/* USER CODE END WHILE */

		/* USER CODE BEGIN 3 */

	}
	/* USER CODE END 3 */

}

/** System Clock Configuration
 */
void SystemClock_Config(void)
{
	RCC_OscInitTypeDef RCC_OscInitStruct;
	RCC_ClkInitTypeDef RCC_ClkInitStruct;

	__PWR_CLK_ENABLE();

	__HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE2);

	RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
	RCC_OscInitStruct.HSEState = RCC_HSE_ON;
	RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
	RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
	RCC_OscInitStruct.PLL.PLLM = 8;
	RCC_OscInitStruct.PLL.PLLN = 336;
	RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV4;
	RCC_OscInitStruct.PLL.PLLQ = 7;
	HAL_RCC_OscConfig(&RCC_OscInitStruct);

	RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);
	RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
	RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
	RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
	RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
	HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2);

	HAL_RCC_MCOConfig(RCC_MCO1, RCC_MCO1SOURCE_HSE, RCC_MCODIV_1);

	HAL_SYSTICK_Config(HAL_RCC_GetHCLKFreq()/1000);

	HAL_SYSTICK_CLKSourceConfig(SYSTICK_CLKSOURCE_HCLK);

}


/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

#ifdef USE_FULL_ASSERT

/**
 * @brief Reports the name of the source file and the source line number
 * where the assert_param error has occurred.
 * @param file: pointer to the source file name
 * @param line: assert_param error line source number
 * @retval None
 */
void assert_failed(uint8_t* file, uint32_t line)
{
	/* USER CODE BEGIN 6 */
	/* User can add his own implementation to report the file name and line number,
    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
	/* USER CODE END 6 */

}

#endif

/**
 * @}
 */

/**
 * @}
 */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
